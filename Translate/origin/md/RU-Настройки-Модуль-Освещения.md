## Управление освещением

- Обзор применения протоколов «DMX512» и «ArtNet»

- Настройки модуля управления «световыми приборами»

- Настройки привязок органов управления

- Конфигурационный файл

- Репитеры, повторители и конвертеры протоколов
  
  - Arduino based [репитер](RU-Репитер-Освещения-DMX512-ARTNET-MQTT) «DMX512», «ArtNet», «MQTT»

В настоящее время, по приемлемым ценам, стало доступно большое количество светового оборудования поддерживающие управление по поотоколу __DMX512__. 

Протокол __DMX512__ разработан для управления световыми приборами. Он позволяет управлять по одной трехпроводной линии связи одновременно `512` каналами. В зависимости от возможностей осветительного прибора, можно изменять цвет, яокость, положение светового луча, переключение эффектов и многие другие характеристики. Как правило, на одном осветительном приборе используются сразу несколько каналов. Несколько включенных одновременно приборов, позволяют с помощью протокола управления __DMX512__, создавать световые картины и элементы оформления самой различной сложности.

Протокол __ArtNet__, это сетевая версия протокола __DMX512__. Распространяется по локальной сети путем рассылки на широковещательные адреса. При этом, конечное оборудование должно поддерживать протокол __ArtNet__, или должен быть установлен гейт для преобразования в протокол __DMX512__.

__MIDI-MT__ поддерживает оба этих протокола, возможна как одновременная работа по обеим протоколам, так и раздельная. Реализована поддержка как стандартных 8 битных каналов, так и 16 битных. Их можно применять одновременно, но при проектировании сети, надо учитывать что 16 битный канал занимает место двух 8 битных каналов. Например, если вы назначили устройству с четырьмя 16 битными каналами DMX адрес 10, то следующий свободный DMX адрес будет под номером 18 а не 14 .

Подробнее о протоколе можно почитать на сайте [dmx-512.ru](https://dmx-512.ru/wiki/dmx_512).  

### Настройки модуля управления «световыми приборами»

Позволяет управлять световыми приборами и оборудованием по протоколам «**DMX512**» и «**ArtNet**».

- Выбор «**COM Порт**» означает выбор последовательного порта, к которому подключен DMX контроллер.  Если это необходимо, параметры порта можно изменить в файле конфигурации путём редактирования.
- Выбор «**ArtNet сеть**» позволит определить, на каком интерфейсе будет производиться рассылка широковещательных пакетов по протоколу ArtNet.
- Поле «**Номер вселенной**» определяет адресацию «вселенной» для протокола ArtNet.
- Выбор «**Порт**» указывает на какой порт отправлять ArtNet данные, по умолчанию номер порта `6454`.
- Опция «**Включить DMX пул**» хоть и является стандартным поведением, но при использовании протокола ArtNet включать её не рекомендуется, так как она создаёт «сетевой шторм», увеличивая нагрузку на локальную сеть. Если ваше световое оборудование работает без этой опции, не используйте её.

<img src="https://claudiacoord.github.io/MIDI-MT/images/helper/MIDI-MT-PLUGIN-Lights.png" title="" alt="" data-align="center">

### Настройки привязок органов управления

Назначить 8 или 16 битные каналы вы можете в редакторе конфигураций. Для назначения канала, выбираете необходимы пункт в подменю `Контроль относиться к управлению светом`:  

- `Канал «8 бит» (стандарт)`, номер группы «251»
- `Канал «16 бит» (расширенный)`, номер группы «250»

![](https://claudiacoord.github.io/MIDI-MT/images/helper/MIDI-MT-PLUGIN-Lights-edit1.png)

В последнем столбце настроек, в группе `назначение`, вам необходимо указать номер __DMX__ канала (адрес). Возможные значения лежат в диапазоне от «1» до «254».

![](https://claudiacoord.github.io/MIDI-MT/images/helper/MIDI-MT-PLUGIN-Lights-edit2.png)

#### Конфигурационный файл

Также возможно отредактировать файл конфигурации в любом привычном для вас редакторе. Основная секция настроек управления освещением выглядит так:

```
    ...
    },
    "lights": {
        "pool": false,
        "dmx": {
          "enable": false,
          "port": 5,
          "baudrate": 250000,
          "stopbits": 2,
          "timeout": 3,
          "name": "USB Serial Port"
        },
        "artnet": {
          "enable": true,
          "port": 6454,
          "universe": 1,
          "ip": "192.168.22.1",
          "mask": "255.255.255.0",
          "broadcast": "192.168.22.255"
        }
    },
    "units":[ ...
         // группа 251 - каналы с разрешением 8 бит.
         // группа 250 - каналы с разрешением 16 бит.
         // target = группа 251 или 250, longtarget = DMX адрес канала на устройстве 
        {"scene":179,"id":14,"type":1,"target":251,"longtarget":5,"onoff":"false","value":11},
        {"scene":179,"id":15,"type":1,"target":251,"longtarget":6,"onoff":"false","value":33},
        {"scene":179,"id":16,"type":1,"target":251,"longtarget":7,"onoff":"false","value":22},
    ... ]
```

### Репитеры, повторители и конвертеры протоколов

Для реализации объединения сетевых технологий __ArtNet__, __MQTT__ и __DMX512__ в единую систему управления световыми приборами можно использовать не только оборудование известных производителей. Гораздо дешевле, использовать для этих целей `Arduino` подобные платы с поддержкой технологии `WiFi`, спроектированные на чтпсетах `ESP`, например `ESP8266`, `ESP32` и т.д.

При этом, получается получить прибор с максимальными возможностями по минимальной цене. Бюджет такого устройства обойдется в стоимость примерно одного трекового светильника, другими словами, его стоимость выйдет примерно в `10-15%` от цены аналогично фирменного оборудования.

Одна из таких конструкций, служащая для расширения охвата сети управляемых устройств, работает под управлением программы __MIDI-MT__, для которой была специально разработана. Простота исполнения и наличие в широкой продаже электронных компонентов делают её универсальной. Это «репитер», который собирает управляющую информацию о состоянии включения осветительных приборов из сетей __ArtNet__ и __MQTT__, далее информация суммируется и передается по протоколу __DMX__ в проводную сеть, через которую идет реальное управление освещением. Использование подразумевает наличие проводной сети __DMX512__ и точки подключения к ней.

Репитер можно подключить к сети __DMX512__ состоящий из одного сегмента. Если сеть управления поделена на несвязанные между собой сегменты, можно установить «репитеры» в каждом сегменте сети, тем самым объединив их в единую сеть. При этом, удаленность расположения сегментов друг от друга не имеет значения, важно что бы все «репитеры» были подключены в единую локальную сеть, при этом подразумевается управление по протоколу __ArtNet__. В случае отсутствия возможности предоставить всем «репитерам» единую локальную сеть, можно использовать управление по протоколу __MQTT__. Стандартный режим работы __MIDI-MT__, это одновременное использование протоколов __ArtNet__ и __MQTT__ для формирования исходящего DMX потока.

В каждом сегменте управления осветительной сетью, где установлен «репитер», он становится «Мастером», при этом сигналы управления __MQTT__ имеют преимущество перед сигналами __ArtNet__. Если ичточник был включен с помощью __MQTT__ управления, его отключение может быть осуществлено только им. Это относится к любым регулировкам, как к включению и выключению, так и к регулировке яркости или изменения цвета. Напротив, если осветительный прибор был включен сигналами из  __ArtNet__ источника, дальнейшее управление могут взять на себя управляющие сигналы по протоколу __MQTT__ .

Подробнее о мульти-протокольных «репитерах» и «конечных точках», можно почитать [тут](RU-Репитер-Освещения-DMX512-ARTNET-MQTT).
